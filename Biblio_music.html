<!DOCTYPE html>
 <html lang="fr">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <link rel="icon" type="image/png" href="images/icone.png">
     <title>K-Pop Website</title>
     <link rel="stylesheet" href="style.css">
     <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
     <style>
      #filters {
          display: flex;
          flex-wrap: wrap;
          margin: 20px;
          gap: 10px;
      }
      .filter {
          display: flex;
          flex-direction: column;
          padding: 10px;
          border-radius: 6px;
          background-color: #111;
          border: 1px solid #333;
      }

      .filter select {
        background-color: #000;
        color: #FFF;
        border: 1px solid #00C5D5;
        padding: 5px;
        border-radius: 4px;
      }
      
      .video-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
          gap: 20px;
          margin: 20px;
      }
      .video-card {
          border: 1px solid #ccc;
          padding: 10px;
          background: #fdfdfd;
          border-radius: 6px;
      }
      .video-card video {
          width: 100%;
          border-radius: 4px;
          cursor: pointer;
          border: 1px solid #444;
          background: #111;
          color: #ccc;
      }
      .video-info {
          font-size: 0.9em;
          margin-top: 10px;
      }
      
      /* Modale */
      .modal {
          position: fixed;
          top: 0;
          left: 0;
          right:0;
          bottom:0;
          background-color: rgba(0, 0, 0, 0.85);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1000;
      }
      .modal.hidden {
          display: none;
      }
      
      .modal-content {
          max-width: 70%;
          max-height: 70%;
          background-color: black;
          border-radius: 8px;
          box-shadow: 0 0 10px #000;
          padding: 10px;
      }
      
      .modal-content video {
          width: 100%;
          height: auto;
          max-height: 500px;
      }

      #close-modal {
          position: absolute;
          top: 10px;
          right: 20px;
          font-size: 2rem;
          color: white;
          cursor: pointer;
      }
      
      #pagination {
          display: flex;
          justify-content: center;
          gap: 8px;
          margin: 20px 0;
          flex-wrap: wrap;
      }
      
      #pagination button {
          padding: 6px 10px;
          background-color: #eee;
          border: 1px solid #ccc;
          border-radius: 4px;
          cursor: pointer;
      }
      
      #pagination button:disabled {
          background-color: #ccc;
          cursor: default;
      }
      
      #pagination span {
          padding: 6px 10px;
          color: #777;
      }

      /* Labels des filtres */
      #filters label {
          color: white;
      }
      
      /* Nouveau bouton "Fermer" */
      #close-btn {
          margin-top: 10px;
          padding: 6px 12px;
          background-color: #333;
          color: white;
          border: none;
          cursor: pointer;
          font-size: 1em;
          border-radius: 4px;
      }

      #modal-controls {
          display: flex;
          justify-content: space-between;
          margin: 10px;
      }
      
      #modal-controls button {
          padding: 8px 14px;
          background-color: #222;
          color: white;
          border: 1px solid #555;
          border-radius: 4px;
          cursor: pointer;
          font-size: 1em;
      }
      
      #modal-controls button:hover {
          background-color: #444;
      }
      
      #close-btn:hover {
          background-color: #555;
      }

     .video-info .highlight {
       color: #000000;
       font-size: 1.1em;
       font-weight: bold;
     }


      .video-info .nombre {
         text-align: center;
         margin-top: 10px;
         font-size: 1.2em;
         color: #8A6ACE;
       }



     </style>
 </head>
 <body>
     <header>
         <h1><span class="color1">K-Pop</span> <span class="color2">Website</span></h1>
         <h2 class="subtitle">Bibliothèque musicale</h2>
     </header>
     <div id="nav-container"></div>
     <!-- Barre latérale -->
     <div id="sidebar">
         <h3>Volume Global</h3>
         <input type="range" id="globalVolume" min="0" max="100" step="1">
         <span id="volumeValue"></span>
     </div>

       <!-- Filtres dynamiques -->
     <div id="filters"></div>
     
     <!-- Conteneur des vidéos -->
     <div id="video-grid" class="video-grid"></div>
     
     <!-- Modale de lecture vidéo en grand -->
     <div id="video-modal" class="modal hidden">
      <div id="modal-controls">
          <button id="prev-video">⟵</button>
         <div class="modal-content">
             <span id="close-modal">&times;</span>
             <video id="modal-video" controls autoplay></video>
             <button id="close-btn">Fermer</button>
         </div>
         <button id="next-video">⟶</button>
      </div>
      </div>

  
     <!-- Pagination (sera rempli dynamiquement) -->
     <div id="pagination"></div>


     <script src="./Donnees_CSV/stats.js"></script>
     <script src="./JS_commun.js"></script>
     <script src="./videos/liste_video.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const csvPath = './Donnees_CSV/Infos.csv';
  const jsonPath = './Donnees_CSV/Credits.json';
  const videoFolder = './videos/';
  const videoGrid = document.getElementById('video-grid');
  const filtersContainer = document.getElementById('filters');

  const MAX_PER_PAGE = 50;
  let currentPage = 1;
  let allData = [];
  let filteredData = [];
  let creditsData = {};

  // Étape 1 : charger d'abord le JSON, puis le CSV
  fetch(jsonPath)
    .then(response => response.json())
    .then(json => {
      creditsData = json;
      Papa.parse(csvPath, {
        download: true,
        header: true,
        complete: function(results) {
          allData = results.data.filter(row => row.Nombre);
          filteredData = allData;
          createFilters(allData);
          displayVideos(allData, 1);
        }
      });
    });

  function createFilters(data) {
    const columns = Object.keys(data[0]);
    columns.forEach(col => {
      if (col === 'Groupe') return;

      const select = document.createElement('select');
      select.id = `filter-${col}`;

      const label = document.createElement('label');
      const colLabel = col
        .replace('Annee', 'Année')
        .replace('Episode', 'Épisode')
        .replace('Generation', 'Génération');

      label.textContent = colLabel + ' : ';
      label.setAttribute('for', select.id);

      const allOption = document.createElement('option');
      allOption.value = '__ALL__';
      allOption.textContent = '-- Tout --';
      allOption.selected = true;
      select.appendChild(allOption);

      if (col === 'Artiste') {
        const artists = Object.keys(creditsData).sort();
        artists.forEach(artist => {
          const option = document.createElement('option');
          option.value = artist;
          option.textContent = artist;
          select.appendChild(option);
        });
      } else {
        let values = [...new Set(data.map(row => row[col]).filter(Boolean))];
        if (col === 'Nombre' || col === 'Episode') {
          values = values.map(Number).sort((a, b) => a - b).map(String);
        } else {
          values.sort();
        }
        values.forEach(val => {
          const option = document.createElement('option');
          option.value = val;
          option.textContent = val;
          select.appendChild(option);
        });
      }

      select.addEventListener('change', () => filterVideos());

      const wrapper = document.createElement('div');
      wrapper.className = 'filter';
      wrapper.appendChild(label);
      wrapper.appendChild(select);
      filtersContainer.appendChild(wrapper);
    });
  }

  function displayVideos(data, page = 1) {
    videoGrid.innerHTML = '';
    currentPage = page;
    filteredData = data;
    const totalPages = Math.ceil(data.length / MAX_PER_PAGE);
    const start = (page - 1) * MAX_PER_PAGE;
    const end = start + MAX_PER_PAGE;
    const videosToShow = data.slice(start, end);

    videosToShow.forEach(video => {
      const index = parseInt(video.Nombre, 10) - 1;
      const filename = videoList[index];
      if (!filename) return;

      const card = document.createElement('div');
      card.className = 'video-card';

      const videoElement = document.createElement('video');
      videoElement.src = videoFolder + filename;
      videoElement.controls = false;
      videoElement.muted = true;
      videoElement.loop = true;
      videoElement.autoplay = true;

      let hoverTimeout;
      videoElement.addEventListener('mouseenter', () => {
        hoverTimeout = setTimeout(() => {
          videoElement.muted = false;
        }, 1000);
      });

      videoElement.addEventListener('mouseleave', () => {
        clearTimeout(hoverTimeout);
        videoElement.muted = true;
      });

      videoElement.addEventListener('click', () => openModal(videoFolder + filename));

      const info = document.createElement('div');
      info.className = 'video-info';

      ['Titre', 'Artiste'].forEach(key => {
        if (video[key]) {
          const p = document.createElement('p');
          p.innerHTML = `<strong>${key}</strong> : ${video[key]}`;
          p.classList.add('highlight');
          info.appendChild(p);
        }
      });

      Object.entries(video).forEach(([key, value]) => {
        if (!['URL', 'Groupe', 'Titre', 'Artiste', 'Nombre'].includes(key)) {
          const label = key
            .replace('Annee', 'Année')
            .replace('Episode', 'Épisode')
            .replace('Generation', 'Génération');
          const p = document.createElement('p');
          p.innerHTML = `<strong>${label}</strong> : ${value}`;
          info.appendChild(p);
        }
      });

      if ('Nombre' in video) {
        const numberP = document.createElement('p');
        numberP.className = 'nombre';
        numberP.textContent = video.Nombre;
        info.appendChild(numberP);
      }

      card.appendChild(videoElement);
      card.appendChild(info);
      videoGrid.appendChild(card);
    });

    renderPaginationControls(totalPages);
  }

  function renderPaginationControls(totalPages) {
    const existing = document.getElementById('pagination');
    if (existing) existing.remove();

    const pagination = document.createElement('div');
    pagination.id = 'pagination';

    if (currentPage > 1) {
      const prevBtn = document.createElement('button');
      prevBtn.textContent = '← Précédent';
      prevBtn.onclick = () => displayVideos(filteredData, currentPage - 1);
      pagination.appendChild(prevBtn);
    }

    for (let i = 1; i <= totalPages; i++) {
      if (i === currentPage || i === 1 || i === totalPages || Math.abs(i - currentPage) <= 2) {
        const pageBtn = document.createElement('button');
        pageBtn.textContent = i;
        pageBtn.disabled = i === currentPage;
        pageBtn.onclick = () => displayVideos(filteredData, i);
        pagination.appendChild(pageBtn);
      } else if ((i === currentPage - 3 || i === currentPage + 3) && totalPages > 5) {
        const dots = document.createElement('span');
        dots.textContent = '...';
        pagination.appendChild(dots);
      }
    }

    if (currentPage < totalPages) {
      const nextBtn = document.createElement('button');
      nextBtn.textContent = 'Suivant →';
      nextBtn.onclick = () => displayVideos(filteredData, currentPage + 1);
      pagination.appendChild(nextBtn);
    }

    videoGrid.parentNode.appendChild(pagination);
  }

  function filterVideos() {
    const filters = Array.from(filtersContainer.querySelectorAll('select'));
    let filtered = allData;

    filters.forEach(select => {
      const col = select.id.replace('filter-', '');
      const selected = Array.from(select.selectedOptions)
        .map(opt => opt.value)
        .filter(val => val !== '__ALL__');

      if (selected.length > 0) {
        if (col === 'Artiste') {
          const validNombres = new Set();
          selected.forEach(artist => {
            (creditsData[artist] || []).forEach(nombre => validNombres.add(nombre));
          });
          filtered = filtered.filter(row => validNombres.has(row.Nombre));
        } else {
          filtered = filtered.filter(row => selected.includes(row[col]));
        }
      }
    });

    displayVideos(filtered, 1);
  }

  const modal = document.getElementById('video-modal');
  const modalVideo = document.getElementById('modal-video');
  const closeModalBtn = document.getElementById('close-modal');
  const closeBtn = document.getElementById('close-btn');

  let currentIndexInFiltered = -1;

  function openModal(src) {
    modal.classList.remove('hidden');
    modalVideo.src = src;
    modalVideo.play();

    const filename = src.replace(videoFolder, '');
    currentIndexInFiltered = filteredData.findIndex(video =>
      videoList[parseInt(video.Nombre, 10) - 1] === filename
    );
   console.log("Index courant dans filteredData :", currentIndexInFiltered);

  }

  function closeModal() {
    modal.classList.add('hidden');
    modalVideo.pause();
    modalVideo.src = '';
  }

  closeModalBtn.addEventListener('click', closeModal);
  closeBtn.addEventListener('click', closeModal);
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeModal();
  });

  document.getElementById('prev-video').addEventListener('click', () => {
    if (currentIndexInFiltered > 0) {
      const prevVideo = filteredData[currentIndexInFiltered - 1];
      openModal(videoFolder + videoList[parseInt(prevVideo.Nombre, 10) - 1]);
    }
  });

  document.getElementById('next-video').addEventListener('click', () => {
    if (currentIndexInFiltered < filteredData.length - 1) {
      const nextVideo = filteredData[currentIndexInFiltered + 1];
      openModal(videoFolder + videoList[parseInt(nextVideo.Nombre, 10) - 1]);
    }
  });
});
</script>

 </body>
 </html>
