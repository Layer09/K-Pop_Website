<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="images/icone.png">
    <title>Save one Drop one IMPOSSIBLE</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
    <h1><span class="color1">K-Pop</span> <span class="color2">Website</span></h1><br>
    <h2 class="subtitle">Save one Drop one <span style="color:#FF0000;">IMPOSSIBLE</span></h2>
</header>

<style>
/* ... style conservé inchangé ... */
</style>

<section style="width: 100%;">
    <div id="nav-container"></div>

    <!-- Sélection du profil -->
    <div id="profil-selection" style="text-align: center; margin-top: 30px;">
        <label for="profil">Qui es-tu ? </label>
        <select id="profil">
            <option value="">-- Sélectionne ton profil --</option>
            <option value="Andy">Andy</option>
            <option value="Anna">Anna</option>
            <option value="Gwenola">Gwenola</option>
            <option value="Laurana">Laurana</option>
            <option value="Melyssa">Melyssa</option>
        </select>
    </div>

    <!-- Barre latérale -->
    <div id="sidebar">
        <h3>Volume Global</h3>
        <input type="range" id="globalVolume" min="0" max="100" step="1">
        <span id="volumeValue"></span>
    </div>
</section>

<section id="challenge-section">
    <div id="single-video" class="single-video hidden">
        <video width="1440" height="810" id="videoA" controls></video>
    </div>

    <div id="second-video" class="single-video hidden">
        <video width="1440" height="810" id="videoB" controls></video>
    </div>

    <div id="dual-videos" class="video-container hidden">
        <video id="choiceA" width="320" height="180" muted autoplay loop></video>
        <video id="choiceB" width="320" height="180" muted autoplay loop></video>
    </div>
</section>

<script src="./JS_commun.js"></script>

<script>
let liste_0 = [], liste_5 = [], liste_10 = [], liste_15 = [], liste_20 = [];
let liste_25 = [], liste_30 = [], liste_35 = [], liste_40 = [], liste_45 = [];
let liste_50 = [], liste_55 = [], liste_60 = [], liste_65 = [], liste_70 = [];
let liste_75 = [], liste_80 = [], liste_85 = [], liste_90 = [], liste_95 = [], liste_100 = [];

const allLists = {
    liste_0, liste_5, liste_10, liste_15, liste_20,
    liste_25, liste_30, liste_35, liste_40, liste_45,
    liste_50, liste_55, liste_60, liste_65, liste_70,
    liste_75, liste_80, liste_85, liste_90, liste_95, liste_100
};

let firstVideo = '';
let secondVideo = '';

document.getElementById('profil').addEventListener('change', async function () {
    const profil = this.value;
    if (!profil) return;

    const chemin = `./Donnees_CSV/Listes-Save_one-Drop_one/${profil}.json`;
    try {
        const response = await fetch(chemin);
        const data = await response.json();

        // Charger toutes les listes dans les variables
        for (let i = 0; i <= 100; i += 5) {
            let key = `liste_${i}`;
            if (data[key]) {
                allLists[key] = [...data[key]]; // copier la liste
            } else {
                allLists[key] = [];
            }
        }

        // Lancer le challenge
        startChallenge();
    } catch (e) {
        console.error("Erreur lors du chargement du JSON :", e);
        alert("Impossible de charger les vidéos pour ce profil.");
    }
});

function getRandomNonEmptyList() {
    const nonEmptyLists = Object.entries(allLists).filter(([_, liste]) => liste.length >= 2);
    if (nonEmptyLists.length === 0) return null;

    const [key, liste] = nonEmptyLists[Math.floor(Math.random() * nonEmptyLists.length)];
    return { key, liste };
}

function startChallenge() {
    cleanupVideos();

    const selection = getRandomNonEmptyList();
    if (!selection) {
        alert("Bravo ! Tu as terminé toutes les vidéos !");
        return;
    }

    const { key, liste } = selection;

    // Sélectionner deux vidéos aléatoires
    const indices = [];
    while (indices.length < 2) {
        const i = Math.floor(Math.random() * liste.length);
        if (!indices.includes(i)) indices.push(i);
    }

    firstVideo = liste[indices[0]];
    secondVideo = liste[indices[1]];

    // Supprimer les vidéos de la liste
    allLists[key] = liste.filter((_, idx) => !indices.includes(idx));

    const singleContainer = document.getElementById('single-video');
    const videoA = document.getElementById('videoA');
    singleContainer.classList.remove('hidden');
    videoA.src = './videos/' + firstVideo;
    videoA.play();

    videoA.onended = () => {
        videoA.pause();
        singleContainer.classList.add('hidden');

        const secondContainer = document.getElementById('second-video');
        const videoB = document.getElementById('videoB');
        secondContainer.classList.remove('hidden');
        videoB.src = './videos/' + secondVideo;
        videoB.play();

        videoB.onended = () => {
            videoB.pause();
            secondContainer.classList.add('hidden');

            // Montrer les petites vidéos
            document.getElementById('dual-videos').classList.remove('hidden');
            choiceA.src = './videos/' + firstVideo;
            choiceB.src = './videos/' + secondVideo;
            choiceA.play();
            choiceB.play();
        };
    };
}

function cleanupVideos() {
    // Nettoyer les grosses vidéos
    const videoA = document.getElementById('videoA');
    const videoB = document.getElementById('videoB');
    videoA.pause(); videoA.src = '';
    videoB.pause(); videoB.src = '';

    document.getElementById('single-video').classList.add('hidden');
    document.getElementById('second-video').classList.add('hidden');

    // Nettoyer les vidéos de choix
    choiceA.pause(); choiceA.src = '';
    choiceB.pause(); choiceB.src = '';
    document.getElementById('dual-videos').classList.add('hidden');
}

choiceA.onclick = () => {
    cleanupChoices();
};

choiceB.onclick = () => {
    cleanupChoices();
};

function cleanupChoices() {
    cleanupVideos();
    startChallenge();
}

let hoverTimeoutA, hoverTimeoutB;

choiceA.addEventListener('mouseenter', () => {
    hoverTimeoutA = setTimeout(() => {
        choiceA.muted = false;
    }, 1000);
});
choiceA.addEventListener('mouseleave', () => {
    clearTimeout(hoverTimeoutA);
    choiceA.muted = true;
});

choiceB.addEventListener('mouseenter', () => {
    hoverTimeoutB = setTimeout(() => {
        choiceB.muted = false;
    }, 1000);
});
choiceB.addEventListener('mouseleave', () => {
    clearTimeout(hoverTimeoutB);
    choiceB.muted = true;
});
</script>

</body>
</html>
